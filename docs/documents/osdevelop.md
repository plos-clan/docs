# è‡ªåˆ¶OSæ•™ç¨‹#0 : é¢„å¤‡

archlinux: gcc(clang) nasm

# è‡ªåˆ¶OSæ•™ç¨‹#1 : æ­¥å…¥bootloaderçš„å¤§é—¨

~~è¿™é‡Œä»€ä¹ˆä¹Ÿæ²¡æœ‰~~  

ä»€ä¹ˆï¼Œä½ é—®æˆ‘æ€ä¹ˆå†™å¼•å¯¼?  
æ‰‹å†™MBR?  
å€ŸåŠ©GNU-EFIæˆ–è€…EDK2è¿™æ ·çš„å¼ºå¤§å·¥å…·ç¼–å†™UEFIå¼•å¯¼?  
æˆ–è€…æ˜¯GRUB?  
ä»Šå¤©è®©æˆ‘å¸®ä½ è„±ç¦»è‹¦æµ·ğŸ˜‹  
LIMINE!æ°¸è¿œçœŸç¥!  
æ”¾å¼ƒå›°éš¾ï¼Œé€‰æ‹©limine!  
é˜¿é—¨!  

è¿™é‡Œæœ‰limineçš„ä»‹ç»ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹çœ‹:[limine explain](https://github.com/limine-bootloader/limine)  

~~é¦–å…ˆï¼Œåœ¨ä½ è‡ªå·±çš„osæºç æ–‡ä»¶å¤¹ä¸‹é¢ä»githubæ‹‰å–limine~~  
ä½ å¯ä»¥ç”¨æˆ‘ä»¬ç¤¾åŒºæä¾›çš„[Limine C Xmake Template](https://github.com/plos-clan/limine-xmake-template)å¼•å¯¼æ¨¡æ¿å³å¯  

ç›´æ¥åƒè¿™æ ·æ“ä½œ:<br>
```bash
git clone https://github.com/plos-clan/limine-xmake-template.git
```

ä½ å¯èƒ½ä¼šé—®: ä»€ä¹ˆ,å¦‚æ­¤ç®€å•?  
æ˜¯çš„æ˜¯çš„ä½ è¯´çš„å¯¹,ç¡®å®å¦‚æ­¤ç®€å•  

æ¥ä¸‹æ¥è¦å¹²ä»€ä¹ˆ?  
~~ç‰¹ä¹ˆä»“åº“readme.mdä¸çœ‹ä¹ˆ~~  
å—¯ï¼Œä½ å°±å¯ä»¥åœ¨src/main.cå¼€å§‹ä½ çš„æ—…ç¨‹è¾£!  

ç¼–è¯‘æŒ‡ä»¤ï¼šåœ¨å·¥ä½œç›®å½•ä¸‹é¢è¾“å…¥: 
```bash
xmake
```
ç¼–è¯‘æºç å³å¯  

æ˜¯çš„ä½ æ²¡æœ‰çœ‹é”™, æ˜¯[xmake](https://xmake.io/guide/quick-start.html), ä¸æ˜¯ç…ç¬”ä¸€èˆ¬çš„cmakeæˆ–è€…make.  
ä¸éœ€è¦ä½ å†™ä¸€å¤§å¨çš„CMakelist, ä¸éœ€è¦ä½ ä¸€ä¸ªä¸€ä¸ªæ–‡ä»¶å¤¹å†™Makefile, ä¸€ä¸ªxmake.luaè¶³çŸ£.  

æ²¡äº†?  
æ˜¯çš„ï¼Œbootloaderå°±è¿™æ ·ç»“æŸäº†,ä¸€ä¸ªlimineå°±æå®š, ç®€å•, ä¾¿åˆ©, æ²¡æœ‰ç¹æ‚çš„æ‰€è°“"æŠŠboot.binå†™åˆ°0å·æ‰‡åŒº, å‰512ä¸ªå­—èŠ‚æˆ‘ä»¬è¦åˆ‡åˆ°ä¿æŠ¤æ¨¡å¼, lbaè¯»ç›˜, æ‰¾åˆ°loader.bin, åˆ‡æ¢é•¿æ¨¡å¼, VBE, é¢„å¤‡é¡µè¡¨...","ä½¿ç”¨UEFIæä¾›çš„Protocolè·å–acpiè¡¨, å¾—åˆ°å†…æ ¸åœ°å€å¹¶è§£æelfæ–‡ä»¶,é‡å®šä½,è·å–graphic frame, æ‹¿åˆ°efi memory map..."ä¹‹ç±»çš„ä¸œè¥¿.
å¦‚æœæˆ‘ä»¬è¦ç”¨åˆ°ä¸€äº›å¯åŠ¨æ—¶çš„ä¿¡æ¯, æ¯”å¦‚memory map, æˆ‘ä»¬åªéœ€è¦åœ¨æºæ–‡ä»¶é‡Œé¢è¿™æ ·åš:
```c
__attribute__( ( used, section( ".requests" ) ) ) volatile limine_memmap_request memmap_request = {
    .id = LIMINE_MEMMAP_REQUEST,
    .revision = 3,
    .response = nullptr
};
```
å…¶ä¸­,revisionè§†æƒ…å†µè€Œå®š, ä½ ä½¿ç”¨çš„limineç‰ˆæœ¬æ˜¯å¤šå°‘å°±å¡«å¤šå°‘.  
- æ³¨æ„: ç¬¬ä¸‰ä»£limineä¸é»˜è®¤æ˜ å°„0~4GBç‰©ç†åœ°å€åˆ°HHDM, åªæ˜ å°„éƒ¨åˆ†, åæœŸæˆ‘ä»¬ä¼šè®²åˆ°, è¿™é‡Œå…ˆæ‰“ä¸ªé¢„é˜²é’ˆ


# è‡ªåˆ¶OSæ•™ç¨‹#2 : ä¸²å£, å¯åŠ¨!
ä¸ºå•¥è¦å…ˆå†™ä¸²å£,ä½ å…ˆåˆ«æ€¥,æˆ‘åé¢ä¼šæ…¢æ…¢å‘Šè¯‰ä½ åŸå› .  
ä¸²å£çš„æ–‡ç« å¯ä»¥åœ¨osdevä¸Šæ‰¾åˆ°: [serial_port](https://wiki.osdev.org/Serial_Ports)  
åœ¨æ­¤ä¹‹å‰, æˆ‘ä»¬éœ€è¦å®ç°è¿™ä¹ˆä¸€äº›å‡½æ•°:io_in8, io_out8, io_in16, io_out16, io_in32, io_out32  
è¿™äº›å‡½æ•°æ˜¯æˆ‘ä»¬è¿›è¡Œioæ“ä½œçš„ä¸€ä¸ªåŸºç¡€, å½“ç„¶ä»¥åå­¦äº†dma, mmioä¹‹ç±»çš„ä¸œè¥¿ä½ ä¼šæ›´èƒ½ç†è§£ä»–ä»¬çš„ä½œç”¨äº†.  
Cç‰ˆæœ¬
```c
static inline uint8_t io_in8(uint16_t port) {
    uint8_t data;
    __asm__ volatile("inb %w1, %b0" : "=a"(data) : "Nd"(port));
    return data;
}

static inline uint16_t io_in16(uint16_t port) {
    uint16_t data;
    __asm__ volatile("inw %w1, %w0" : "=a"(data) : "Nd"(port));
    return data;
}

static inline uint32_t io_in32(uint16_t port) {
    uint32_t data;
    __asm__ volatile("inl %1, %0" : "=a"(data) : "Nd"(port));
    return data;
}

static inline void io_out8(uint16_t port, uint8_t data) {
    __asm__ volatile("outb %b0, %w1" : : "a"(data), "Nd"(port));
}

static inline void io_out16(uint16_t port, uint16_t data) {
    __asm__ volatile("outw %w0, %w1" : : "a"(data), "Nd"(port));
}

static inline void io_out32(uint16_t port, uint32_t data) {
    __asm__ volatile("outl %0, %1" : : "a"(data), "Nd"(port));
}
```
C++ç‰ˆæœ¬å¯ä»¥çœ‹è¿™é‡Œï¼š[io.hpp](https://github.com/SegmentationFaultCD/QuantumNEC/blob/limine/include/kernel/driver/cpu/io.hpp)ä»¥åŠ[io.cpp](https://github.com/SegmentationFaultCD/QuantumNEC/blob/limine/source/kernel/driver/cpu/io.cpp)  

- uint32_tè¿™äº›éƒ½æ˜¯ä¸€äº›æ ‡é‡çš„typedef, ä½ includeä¸€ä¸‹stdint.hå°±è¡Œäº†

æ¥ç€æŒ‰ç…§osdevæ•™çš„åŠæ³•åˆå§‹åŒ–ä¸²å£, å¦‚ä¸‹(æ„Ÿè§‰æˆ‘éƒ½æ²¡å¿…è¦è´´ä»£ç )
```c
#define PORT 0x3f8

static int support_serial_ports;

static int init_serial() {
   io_out8(PORT + 1, 0x00);    
   io_out8(PORT + 3, 0x80);   
   io_out8(PORT + 0, 0x03);   
   io_out8(PORT + 1, 0x00);    
   io_out8(PORT + 3, 0x03);  
   io_out8(PORT + 2, 0xC7);    
   io_out8(PORT + 4, 0x0B); 
   io_out8(PORT + 4, 0x1E);    
   io_out8(PORT + 0, 0xAE);  
    if ( IO::in8( PORT + 0 ) != 0xAE ) {
        support_serial_port = 0;
    }
    else {
        io_out8( PORT + 4, 0x0F );
        support_serial_port = 1;
    }


   return 0;
}

// è¯»æ“ä½œ
char read_serial(void) {
    if ( support_serial_port ) {
        while ( io_in8( PORT + 5 ) & 1 );
        return io_in8( PORT );
    }
    return '\0';
}
// å†™æ“ä½œ
void write_serial(char ch) {
    if ( support_serial_port ) {
        while ( !( io_in8( PORT + 5 ) & 0x20 ) );
        io_out8( PORT, ch );
    }
    return;
}
void print(const char* str) {
    for (uint64_t i = 0 ; str[i] != '\0; ++i) {
        write_serial(str[i]);
    }
}
```
åˆ°ç›®å‰ä¸ºæ­¢, ä¸€åˆ‡æ­£å¸¸çš„è¯, æˆ‘ä»¬å°±å·²ç»å†™å¥½äº†ä¸²å£, ä½ å¯ä»¥æµ‹è¯•ä¸€ä¸‹çœ‹çœ‹comç«¯å£æ˜¯å¦æœ‰è¾“å‡º.  
åœ¨xmake.luaçš„qemuçš„flagsä¸­æ·»åŠ å…¥`-serial chardev:com1 -chardev stdio,mux=on,id=com1`æŒ‡ä»¤å³å¯  
å€˜è‹¥æˆåŠŸï¼Œè¯·æŸ¥çœ‹ä¸‹ä¸€ä¸ªæ•™ç¨‹ğŸ˜‹
# è‡ªåˆ¶OSæ•™ç¨‹#3 : æ²¡é¸Ÿç”¨å…¨å±€æ®µæè¿°ç¬¦è¡¨

- ä½œè€…æç¤º : è¿™ç©æ„æ²¡å•¥ç”¨æˆ‘å°±æ²¡è¯¦ç»†çœ‹, å¯èƒ½éœ€è¦å‹˜è¯¯

é‡äº‹ä¸å†³, å…ˆèµ°ä¸€éæ–‡æ¡£, intelæ‰‹å†Œæ˜¯æˆ‘ä»¬å†™OSæœ€å¤§çš„åŠ©æ‰‹  
intelå®˜ç½‘æä¾›äº†ä¸‹è½½åœ°å€[intel docx](https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html)  
å…ˆæŠŠæ‰‹å†Œæåˆ°æ‰‹ï¼Œæ‰‹ä¸­æ‰ç®—æ˜¯æœ‰äº†å·¥å…·ï¼Œæˆ‘ä»¬æ‰èƒ½è¿›ä¸€æ­¥å¼€å‘  
å…¨å±€æè¿°ç¬¦è¡¨åœ¨ä¿æŠ¤æ¨¡å¼ä¸­ä»¥ä½œä¸ºå†…å­˜ç®¡ç†ä¸­çš„åˆ†æ®µ(Segmenting)çš„å·¥å…·, ä½†æ˜¯åˆ†æ®µä½¿ç”¨æå…¶å¤æ‚, å®ç”¨æ€§è¿œä¸å¦‚åˆ†é¡µ(Paging), ä»¥è‡³äºé•¿æ¨¡å¼ç›´æ¥å¼ºåˆ¶ä½¿ç”¨äº†åˆ†é¡µè€Œéåˆ†æ®µæ¥è¿›è¡Œå†…å­˜ç®¡ç†, åˆ†æ®µæœºåˆ¶ä¹Ÿåœ¨é•¿æ¨¡å¼ä¸­è¢«åºŸé™¤äº†  
æ—¢ç„¶å…¨å±€æè¿°ç¬¦è¡¨åœ¨é•¿æ¨¡å¼å·²ç»æ²¡ä»€ä¹ˆç”¨äº†, æ‰€ä»¥å®ƒä»…èµ·åˆ°ä¸€ä¸ªç±»ä¼¼å ä½ç¬¦çš„ä½œç”¨, ç›®å‰æ¥çœ‹, åªæœ‰syscall/sysretæŒ‡ä»¤è¦åˆ©ç”¨åˆ°å…¨å±€æè¿°ç¬¦è¡¨, å…¶ä¸­ä»£ç æ®µ, æ•°æ®æ®µçš„é¡ºåºæ’åˆ—è¦éµå¾ªABIè§„å®š  
æˆ‘ä»¬åªéœ€è¦5ä¸ªæ®µæè¿°ç¬¦å’Œä¸€ä¸ªç³»ç»Ÿæ®µæè¿°ç¬¦(16byte, åˆå«åšä»»åŠ¡çŠ¶æ€æ®µ)  
å…¨å±€æè¿°ç¬¦è¡¨çš„ç»„æˆå¾ˆç®€å•, å°±æ˜¯ç”±8byteå¤§å°çš„æ®µæè¿°ç¬¦(Segment Descriptor)ç»„æˆ, å®ƒæœ€å¤§å¯ä»¥æœ‰8192ä¸ªæ®µæè¿°ç¬¦, æ®µæè¿°ç¬¦ç»“æ„å¦‚ä¸‹  

| 63 -- 56 | 55 | 54 | 53 | 52       | 51 -- 48 | 47 | 46 -- 45 | 44 | 43 | 42 | 41 | 40 | 39 -- 16 | 15 -- 0 |
|----------|----|----|----|----------|----------|----|----------|----|----|----|----|----|----------|---------|
| base     | G	| DB | L  | reserved | limit    | P  | DPL      | S  | E  | DC | RW | A  | base     | limit   |

~~æ²¡é”™å°±æ˜¯è¿™ä¹ˆç¥ç»ç—…  ~~
osdevé‡Œé¢æ˜¯è¿™ä¹ˆè®²çš„: In 64-bit mode, the Base and Limit values __are ignored__, each descriptor covers the __entire linear__ address space regardless of what they are set to.  
base, limitè¿™ä¸¤ä¸ªå±ç”¨æ²¡æœ‰, ä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯å¾—æŒ‰ç…§çº¦å®šè®¾ç½®  
ç¬¬ä¸€ä¸ªæ®µæè¿°ç¬¦æ˜¯ç©ºçš„, å•¥ä¹Ÿä¸è¦å¼„  
ç¬¬äºŒä¸ªæ®µæè¿°ç¬¦æ˜¯å†…æ ¸ä»£ç æ®µ, base=0, limit=0xFFFFF, RW, E, S, P, G, Lè®¾ç½®ä¸º1, DPLè®¾ç½®ä¸º0  
ç¬¬ä¸‰ä¸ªæ®µæè¿°ç¬¦æ˜¯å†…æ ¸æ•°æ®æ®µ, base=0, limit=0xFFFFF, RW, S, P, G, DBè®¾ç½®ä¸º1, DPLè®¾ç½®ä¸º0  
ç¬¬å››ä¸ªæ®µæè¿°ç¬¦æ˜¯ç”¨æˆ·ä»£ç æ®µ, base=0, limit=0xFFFFF, RW, E, S, P, G, Lè®¾ç½®ä¸º1, DPLè®¾ç½®ä¸º3  
ç¬¬äº”ä¸ªæ®µæè¿°ç¬¦æ˜¯ç”¨æˆ·æ•°æ®æ®µ, base=0, limit=0xFFFFF, RW, S, P, G, DBè®¾ç½®ä¸º1, DPLè®¾ç½®ä¸º3  
è¿™äº›ä½æ˜¯å¹²ä»€ä¹ˆç”¨çš„å¯ä»¥çœ‹intelæ‰‹å†Œ`CHAPTER 3 PROTECTED-MODE MEMORY MANAGEMENT`.  

é•¿æ¨¡å¼ä¸‹ç³»ç»ŸçŠ¶æ€æ®µç»“æ„å¦‚ä¸‹
| 127 -- 96 | 95 -- 56 | 55 | 54 | 53 | 52       | 51 -- 48 | 47 | 46 -- 45 | 44 | 43 -- 40 | 39 -- 16 | 15 -- 0 |
|-----------|----------|----|----|----|----------|----------|----|----------|----|----------|----------|---------|
| reserved  | base     | G  | DB | L  | reserved | limit    | P  | DPL      | S  | type     | base     | limit   |

è¿™ä¸ªæ®µå°±æ˜¯ç»™TSSå‡†å¤‡çš„  
é•¿æ¨¡å¼ä¸‹type(Type of system segment)å¯ä»¥å¡«å†™å¦‚ä¸‹æ•°æ®:  
0x2: LDT  
0x9: 64-bit TSS (Available)  
0xB: 64-bit TSS (Busy)  

åœ¨ç¬¬å…­ä¸ªæ®µæè¿°ç¬¦ä¹‹å‰, æˆ‘ä»¬è¿˜å¾—å…ˆå†™ä¸€ä¸‹TSS(Task State Segment)ç»“æ„
```c
typedef struct {
    uint32_t reserved1;
    uint64_t rsp[ 3 ];
    uint64_t reserved2;
    uint64_t ist[ 7 ];
    uint64_t reserved3;
    uint32_t io_map_base_address;
} TaskStateSegment;
```
ä½ åˆ«çœ‹ä»–å«ä»»åŠ¡çŠ¶æ€æ®µ, é•¿æ¨¡å¼ä¸‹æˆ‘ä»¬åªç”¨å®ƒæ¥å­˜å‚¨ä»»åŠ¡çš„ä¸­æ–­å†…æ ¸æ ˆåœ°å€(ä¸€èˆ¬ç”¨rsp[0]æ¥å­˜).  
ç­‰æˆ‘ä»¬åˆ°å¤šæ ¸çš„æ—¶å€™ä¼šæ¥å›é¡¾ä¸€ä¸‹, ç°åœ¨æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ª.  
ç¬¬å…­ä¸ªæ®µæè¿°ç¬¦æ˜¯ç³»ç»Ÿæ®µæè¿°ç¬¦, ç³»ç»Ÿæ®µæè¿°ç¬¦è¦å ç”¨ä¸¤ä¸ªæ®µæè¿°ç¬¦çš„ä½ç½®, base=ä½ tssç»“æ„çš„åœ°å€, limit=__sizeof(TaskStateSegment)-1__, Pè®¾ç½®ä¸º1, typeè®¾ç½®ä¸º9  
åœ¨è¿™äº›æ®µæè¿°ç¬¦è®¾ç½®å¥½å, æˆ‘ä»¬è¦åšçš„å°±æ˜¯å†™å…¥GDT register(GDTR), æŒ‚è½½GDT.  

GDTRç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤º
```c
typedef struct {
    uint16_t size;   // sizeof(SegmentDescriptor) * æ®µæè¿°ç¬¦æ•°é‡ - 1
    uint64_t offset; // å¡«å…¥ä½ çš„GDTåœ°å€
} GDTR;
```
ç„¶å, ç”¨è¿™æ ·ä¸€æ¡æŒ‡ä»¤æŒ‚è½½GDT, å¹¶è®¾ç½®æ®µå¯„å­˜å™¨
```c
__asm__ __volatile__( "lgdt %0" ::"m"( gdtr ) : );
__asm__ __volatile__(
    "movq %%rax, %%ds \n\t"
    "movq %%rax, %%es \n\t"
    "movq %%rax, %%fs \n\t"
    "movq %%rax, %%gs \n\t"
    "movq %%rax, %%ss \n\t"
    "pushq %[SELECTOR_CODE64] \n\t"
    "leaq .next(%%rip),%%rax \n\t"
    "pushq %%rax \n\t"
    "lretq \n\r"
    ".next: \n\t" : : [SELECTOR_CODE64] "i"( SELECTOR_CODE64_KERNEL ),
                      [SELECTOR_DATA64] "a"( SELECTOR_DATA64_KERNEL ) : );
```
å“¦å¿˜è®°å‘Šè¯‰å„ä½, SELECTOR_CODE64_KERNELå°±æ˜¯ä½ æ®µæè¿°ç¬¦åœ¨GDTRä¸­çš„åç§»é‡, æ¯”å¦‚æˆ‘å†…æ ¸ä»£ç æ®µåœ¨GDTçš„åç§»é‡å°±æ˜¯0x8, å†…æ ¸æ•°æ®æ®µåœ¨GDTçš„åç§»é‡å°±æ˜¯0x10<br>
è¿˜æœ‰ä¸€ä»¶äº‹, æŒ‚è½½tss
```c
 __asm__ __volatile__( "ltr %%ax" ::"a"( SELECTOR_TSS ) : "memory" );
```
SELECTOR_TSSçš„å€¼ä¸º0x28, ä¹Ÿå°±æ˜¯å‰æ–‡æ‰€æåˆ°çš„å¼€å¤´åœ¨GDTä¸­çš„åç§»é‡
åšå®Œè¿™äº›, æˆ‘ä»¬GDTå°±ç®—æ˜¯åˆå§‹åŒ–å®Œæˆäº†.

# è‡ªåˆ¶OSæ•™ç¨‹#4 : ä¸­æ–­æè¿°ç¬¦è¡¨!ä¸­æ–­åˆæ­¥
åœ¨intelç™½çš®ä¹¦çš„`CHAPTER 6 INTERRUPT AND EXCEPTION HANDLING`è¿™ä¸€èŠ‚ä¸­, å¯¹ä¸­æ–­è¿›è¡Œäº†è¯¦ç»†çš„ä»‹ç», æœ‰å…´è¶£çš„å¯ä»¥è¯»ä¸€è¯»(å¼ºçƒˆå»ºè®®å…ˆè¯»æ–‡æ¡£å†å†™, æˆ‘ä»¬å†™æ“ä½œç³»ç»Ÿå°±æ˜¯ä¸ºäº†äº†è§£åº•å±‚åŸç†, ä»€ä¹ˆ?ä½ é—®æˆ‘ä¸ºä»€ä¹ˆé‚£ä¹ˆçˆ±è°ƒåº“?å­©å­ä½ å…ˆå¥½å¥½å»çœ‹çœ‹æ“ä½œç³»ç»Ÿè€ƒçº§çš„å¤§çº²å§)  
ä¸­æ–­æè¿°ç¬¦è¡¨(Interrupt Descriptor Table, IDT), ç”¨äºå‘ŠçŸ¥CPUä¸­æ–­æœåŠ¡å¤„ç†ç¨‹åº(ISR)çš„ä½ç½®, ä¸€ä¸ªIDTç”±256ä¸ªé—¨æè¿°ç¬¦æè¿°ç¬¦(Gate Descriptor)ç»„æˆ.  
é—¨çš„ç±»å‹å…±æœ‰ä¸‰ç§, ä¸­æ–­é—¨, é™·é˜±é—¨, ä»»åŠ¡é—¨, é•¿æ¨¡å¼é‡Œé¢ä»»åŠ¡é—¨ä¸å­˜åœ¨, åªæœ‰å‰é¢ä¸¤ç§é—¨  
IDTå…¶å®æ ¹å‰é¢çš„GDTå¾ˆåƒ, æ‰€ä»¥æœ‰å…³IDTæˆ‘ä»¬å°±ç®€å•å¸¦è¿‡.  
é—¨æè¿°ç¬¦ç»“æ„å¦‚ä¸‹
| 127 -- 96 | 95 -- 48 | 47 | 46 -- 45 | 44 | 43 -- 40  | 39 -- 35 | 34 -- 32 | 31     --     16 | 15 -- 0 |
|-----------|----------|----|----------|----|-----------|----------|----------|------------------|---------|
| reserved  | offset   | P  | DPL      | 0  | gate type | reserved | IST      | segment selector | offset  |

SelectoræŒ‡å‘GDTä¸­çš„å¯¹åº”ä»£ç æ®µ(kernel, user), è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘è¦å…ˆå†™GDTå†å†™IDT  
Gate Typeæœ‰ä¸¤ç§å€¼  
0b1110 or 0xE: 64-bitä¸­æ–­é—¨  
0b1111 or 0xF: 64-bité™·é˜±é—¨  
OffsetæŒ‡å‘ä½ çš„ä¸­æ–­å¤„ç†æœåŠ¡å‡½æ•°çš„åœ°å€  
ISTä¸€èˆ¬ä¸º0ï¼Œ å¦‚æœè®¾ç½®è¡¨ç¤ºä¸­æ–­å †æ ˆè¡¨åœ¨TSSä¸­çš„åç§»é‡  
Pä½ä¸€èˆ¬éƒ½è¦è®¾ç½®ä¸º1  
å…ˆæ¥çœ‹çœ‹æˆ‘ä»¬è¦ä¸­æ–­è¦ä¿å­˜ä»€ä¹ˆ: æ®µå¯„å­˜å™¨(ss, cs...), é€šç”¨å¯„å­˜å™¨(rax...), æ ˆæŒ‡é’ˆ(rsp), ç¨‹åºè®¡æ•°å™¨(RIP),ç¨‹åºçŠ¶æ€å­—(PSW => rflags), å¼‚å¸¸ä¸­æ–­è¿˜æœ‰é”™è¯¯ç (error code)

```c
typedef struct {
    uint64_t ds;
    uint64_t es;
    uint64_t fs;
    uint64_t gs;
    uint64_t rax;
    uint64_t rbx;
    uint64_t rcx;
    uint64_t rdx;
    uint64_t rbp;
    uint64_t rsi;
    uint64_t rdi;
    uint64_t r8;
    uint64_t r9;
    uint64_t r10;
    uint64_t r11;
    uint64_t r12;
    uint64_t r13;
    uint64_t r14;
    uint64_t r15;
    uint64_t vector;
    uint64_t error_code;
    void *rip;
    uint64_t cs;
    uint64_t rflags;
    uint64_t rsp;
    uint64_t ss;
} InterruptFrame;
```

å…ˆæŠŠä¸­æ–­æœåŠ¡å¤„ç†å‡½æ•°ç»™å†™äº†å§, ä½†æ˜¯æˆ‘ä»¬è¦è€ƒè™‘å“ªäº›é—¨æ˜¯é™·é˜±, å“ªäº›æ˜¯ä¸­æ–­, é™·é˜±è¦è€ƒè™‘æ˜¯å¦æœ‰é”™è¯¯ç   
intelæ‰‹å†Œä¸Šé¢æœ‰è¯¦å°½çš„ä»‹ç», è‡ªå·±çœ‹

```asm

.macro TRAP_ENTRY_ERRORCODE n         
.GLOBAL interrupt_handler\n
interrupt_handler\n:
    CLI
    NOP
    PUSH \n
    JMP save_all_registers
.endm

.macro TRAP_ENTRY_NOERRORCODE n         
.GLOBAL interrupt_handler\n
interrupt_handler\n:
    CLI
    PUSH 0
    PUSH \n
    JMP save_all_registers
.endm

.macro INTERRUPT_ENTRY n                
.GLOBAL interrupt_handler\n
.section .text
interrupt_handler\n:
    CLI
    PUSH 0
    PUSH \n
    JMP save_all_registers
.endm
.section .text
 
.GLOBAL save_all_registers
save_all_registers:
    PUSH R15
    PUSH R14
    PUSH R13
    PUSH R12
    PUSH R11
    PUSH R10
    PUSH R9
    PUSH R8
    PUSH RDI
    PUSH RSI
    PUSH RBP
    PUSH RDX
    PUSH RCX
    PUSH RBX
    PUSH RAX 
    MOV  RAX, GS
    PUSH RAX
    MOV  RAX, FS
    PUSH RAX
    MOV  RAX, ES
    PUSH RAX
    MOV  RAX, DS
    PUSH RAX
    MOV  RDI, RSP
    CALL do_IRQ
.GLOBAL return_from_isr
return_from_isr:
    MOV RSP, RAX
    POP RAX
    MOV DS, RAX
    POP RAX
    MOV ES, RAX
    POP RAX
    MOV FS, RAX
    POP RAX
    MOV GS, RAX 
    POP RAX
    POP RBX
    POP RCX
    POP RDX
    POP RBP
    POP RSI
    POP RDI
    POP R8
    POP R9
    POP R10
    POP R11
    POP R12
    POP R13
    POP R14
    POP R15
    ADD RSP, 16
    IRETQ ; ä¸è¦å¿˜äº†Q


TRAP_ENTRY_NOERRORCODE 0x00
TRAP_ENTRY_NOERRORCODE 0x01
TRAP_ENTRY_NOERRORCODE 0x02
TRAP_ENTRY_NOERRORCODE 0x03
TRAP_ENTRY_NOERRORCODE 0x04
TRAP_ENTRY_NOERRORCODE 0x05
TRAP_ENTRY_NOERRORCODE 0x06
; è¿™äº›éƒ½æ˜¯å¤„ç†å¤´, çœç•¥

```
do_IRQå‡½æ•°æ˜¯æˆ‘ä»¬çš„æ€»å¤„ç†å‡½æ•°
```c
InterruptFrame* do_IRQ(InterruptFrame* frane) {
// handleå¯è‡ªç”±å‘æŒ¥, ä½†æ˜¯å¯¹äºexceptionè¦é˜»å¡
}

```
ç„¶å, æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°, ä¸€èˆ¬æ¥è¯´0x00 - 0x1féƒ½æ˜¯trap, å…¶ä»–éƒ½æ˜¯interrupt  
ä¹Ÿæ˜¯å®é­”æ³•, å†™çš„å¾ˆé•¿, ä½†æ˜¯æ²¡æœ‰ä»€ä¹ˆå¥½è§£å†³åŠæ³•  
C++26çš„åå°„ä¼¼ä¹å¯ä»¥å‡å°‘å·¥ä½œé‡, ä½†æ˜¯ç›®å‰æ²¡ä¸€ä¸ªæ”¯æŒ  
åšå®Œè¿™äº›, æŒ‚è½½IDTåŸºæœ¬ä¸GDTä¸€è‡´.  
åªä¸è¿‡åªéœ€è¦ä¸€æ¡**lidt**çš„æŒ‡ä»¤å°±è¡Œäº†  
# è‡ªåˆ¶OSæ•™ç¨‹#5 : é¡µå†…å­˜ç®¡ç†, limineå´­éœ²å¤´è§’

# è‡ªåˆ¶OSæ•™ç¨‹#6 : å†…æ ¸å †?ä½ è®¤çœŸçš„?--Slabå†…å­˜æ± 
# è‡ªåˆ¶OSæ•™ç¨‹#7 : åˆ†é¡µ--ä¸‡æ¶ä¹‹æº, èŒæ–°æ€æ‰‹
ç½‘ä¼ åˆ†é¡µéƒ½æ˜¯æå…¶æŠ½è±¡ä¸”éš¾ä»¥ç†è§£çš„, "èŒæ–°æ€æ‰‹", ä»Šå¤©æˆ‘å°±å¸¦ä½ ç©è½¬åˆ†é¡µ!  
åˆ†é¡µæ˜¯x86ä½“ç³»ç®¡ç†å†…å­˜çš„é‡è¦åŠŸèƒ½, å¼ºå¤§ä¹‹å¤„å¤šåˆ°éš¾ä»¥è¡¨è¿°, åˆ†é¡µåœ¨intelæ‰‹å†Œä¹Ÿæ˜¯æœ‰è¯¦å°½ä»‹ç», å°±åœ¨`CHAPTER 4 PAGING`ä¸­. ~~å°±åœ¨åˆ†æ®µåé¢, intelä½•æ„å‘³~~  
åˆ†é¡µç»„æˆå¾ˆç®€å•: è™šæ‹Ÿåœ°å€(virtual address), é¡µè¡¨(page table), MMU(Memory Manage Unit, å†…å­˜ç®¡ç†å•å…ƒ), ç¼ºé¡µå¤„ç†(page fault handle)  
è™šæ‹Ÿåœ°å€: æ¯çº§é¡µè¡¨åç§»é‡æ‰€æ„æˆçš„æ•°å­—  
é¡µè¡¨: ç‰¹æ®Šçš„æ•°æ®ç»“æ„  
MMU: å¯¹è™šæ‹Ÿåœ°å€è¿›è¡Œç¿»è¯‘, å°†è™šæ‹Ÿé¡µé¢ç¿»è¯‘æˆæ‰€å¯¹åº”çš„ç‰©ç†é¡µæ¡†  
ç¼ºé¡µå¤„ç†: è¿›è¡Œå†™æ—¶å¤åˆ¶, åˆ©ç”¨é¡µé¢ç½®æ¢ç®—æ³•æŒ‘é€‰åˆé€‚é¡µè¿›è¡Œç½®æ¢, æˆ–è€…panic  

æˆ‘ä»¬å…ˆä»é¡µè¡¨å…¥æ‰‹å§  
ä¸€èˆ¬, æœ€é¡¶å±‚é¡µè¡¨çš„å…¥å£åœ°å€å­˜åœ¨**cr3**å¯„å­˜å™¨é‡Œé¢  
cr3å¯„å­˜å™¨å¦‚ä¸‹æ‰€ç¤º  
å½“cr4çš„pcidä½ä¸º0æ—¶:
| 63 -- 32 | 11 -- 5  | 4 | 3 | 2 -- 0   |
|----------|----------|---|---|----------|
| address  | reserved |PCD|PWT| reserved |

ä¸º1æ—¶
| 63 -- 32 | 11 -- 0 |
|----------|---------|
| address  | PCID    |

ç„¶å, ä»addressä¸­è¯»å‡ºæœ€é¡¶å±‚é¡µè¡¨çš„å…¥å£åœ°å€, è¿™é‡Œä»¥5çº§é¡µè¡¨ä¸ºä¾‹
ä¸€ä¸ªäº”çº§é¡µè¡¨æ˜¯ç”±512ä¸ªå››çº§é¡µè¡¨å…¥å£ç»„æˆçš„, æ¯ä¸ªå…¥å£å¤§å°8byte, ä½†æ˜¯æ¯çº§çš„é¡µç›®å½•é¡¹åˆæœ‰æ‰€ä¸åŒ
è¿™ä¸ªå…¥å£çš„åŸºåœ°å€å¯èƒ½æ˜¯ä¸‹ä¸€çº§é¡µè¡¨çš„å…¥å£åœ°å€, ä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸€ä¸ªé¡µçš„åç§»åœ°å€(page offset).

- cr3å¯ä»¥çœ‹æˆpml5e -- ä½œè€…æ³¨
pml5tå†…éƒ¨ç”±512ä¸ªå…¥å£é¡¹æ„æˆ    
addressæŒ‡å‘ä¸‹ä¸€çº§é¡µè¡¨(pml4t)  

pml4e(page table level 4 entry, ä¸‹åŒ)  
| 63 | 62 -- 52 | 51 -- M  | M-1 -- 12 | 11  --  8 | 7 |     6     | 5 | 4 | 3 | 2 | 1 | 0 |
|----|----------|----------|-----------|-----------|---|-----------|---|---|---|---|---|---|
| XD | PK       | reserved | address   | available | 0 | available | A |PCD|PWT|U/S|R/W| P |

pml4tå†…éƒ¨ç”±512ä¸ªå…¥å£é¡¹æ„æˆ   
addressæŒ‡å‘ä¸‹ä¸€çº§é¡µè¡¨(pml3t)  

pml3e
| 63 | 62 -- 52 | 51 -- M  | M-1 -- 12 | 11  --  8 | 7 |     6     | 5 | 4 | 3 | 2 | 1 | 0 |
|----|----------|----------|-----------|-----------|---|-----------|---|---|---|---|---|---|
| XD | PK       | reserved | address   | available | 0 | available | A |PCD|PWT|U/S|R/W| P |

pml3tå†…éƒ¨ç”±512ä¸ªå…¥å£é¡¹æ„æˆ  
PS(bit 7) ä¸º0, address æŒ‡å‘ä¸‹ä¸€çº§é¡µè¡¨(pml2t)
PS(bit 7) ä¸º1, address æŒ‡å‘1Gå¤§å°çš„é¡µ  

pml2e  
| 63 | 62 -- 52 | 51 -- M  | M-1 -- 12 | 11  --  8 |   7   |     6     | 5 | 4 | 3 | 2 | 1 | 0 |
|----|----------|----------|-----------|-----------|-------|-----------|---|---|---|---|---|---|
| XD | PK       | reserved | address   | available | PS(0) | available | A |PCD|PWT|U/S|R/W| P |

pge(1G huge page)
| 63 | 62 -- 52 | 51 -- M  | M-1 -- 30 | 29 -- 13  | 12 | 11  --  9 | 8 |   7   | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
|----|----------|----------|-----------|-----------|----|-----------|---|-------|---|---|---|---|---|---|---|
| XD | PK       | reserved | address   | reserved  |PAT | available | G | PS(1) | D | A |PCD|PWT|U/S|R/W| P |

pml2tå†…éƒ¨ç”±512ä¸ªå…¥å£é¡¹æ„æˆ  
PS(bit 7) ä¸º0, address æŒ‡å‘ä¸‹ä¸€çº§é¡µè¡¨(pml1t)
PS(bit 7) ä¸º1, address æŒ‡å‘2Må¤§å°çš„é¡µ
pml1e
| 63 | 62 -- 52 | 51 -- M  | M-1 -- 12 | 11  --  8 |   7   |     6     | 5 | 4 | 3 | 2 | 1 | 0 |
|----|----------|----------|-----------|-----------|-------|-----------|---|---|---|---|---|---|
| XD | PK       | reserved | address   | available | PS(0) | available | A |PCD|PWT|U/S|R/W| P |

pge(2M huge page)
| 63 | 62 -- 52 | 51 -- M  | M-1 -- 21 | 20 -- 13  | 12 | 11  --  9 | 8 |   7   | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
|----|----------|----------|-----------|-----------|----|-----------|---|-------|---|---|---|---|---|---|---|
| XD | PK       | reserved | address   | reserved  |PAT | available | G | PS(1) | D | A |PCD|PWT|U/S|R/W| P |

pml1tå†…éƒ¨ç”±512ä¸ªå…¥å£é¡¹æ„æˆ  
pge(page entry, 4K standard page), address å¯¹åº”ä¸€ä¸ª4Ké¡µçš„å…¥å£
| 63 | 62 -- 52 | 51 -- M  | M-1 -- 12 | 11  --  9 | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
|----|----------|----------|-----------|-----------|---|---|---|---|---|---|---|---|---|
| XD | PK       | reserved | address   | available | G |PAT| D | A |PCD|PWT|U/S|R/W| P |

å¯ä»¥çœ‹å‡º, é¡µè¡¨æ˜¯ä¸€ç§å±‚å±‚é€’è¿›çš„ç‰¹æ®Šç»“æ„, å¹¶ä¸”æ¯ä¸ªé¡µè¡¨çš„å¤§å°éƒ½æ˜¯4096å­—èŠ‚

ç„¶åå†çœ‹è™šæ‹Ÿåœ°å€  

è¿™æ˜¯ä¸€ä¸ª64ä½è™šæ‹Ÿåœ°å€, æˆ‘ä»¬å¯ä»¥æŠŠå®ƒåˆ’åˆ†æˆè¿™ä¹ˆå‡ ä¸ªéƒ¨åˆ†  
| 63 ~ 57 | 56 ~ 48 | 47 ~ 39 | 38 ~ 30 | 29 ~ 21 | 20 ~ 12 | 11 ~ 0 |
|---------|---------|---------|---------|---------|---------|--------|
| 63 ~ 57 | 56 ~ 48 | 47 ~ 39 | 38 ~ 30 | 29 ~ 21 | 20 ~ 12 | 11 ~ 0 |
|available |available | pml5t offset   | pml4t offset   | pml3t offset   | pml2t offset   | pml1t offset  |

è¿™ä¸ªoffsetä»£è¡¨æ­¤è™šæ‹Ÿåœ°å€åœ¨æ¯ä¸ªæ‰€åœ¨é¡µè¡¨å¯¹åº”çš„è™šæ‹Ÿé¡µå·(0 ~ 511)
é™¤äº†é¡µåç§»æ˜¯12ä½, å…¶ä»–çš„éƒ½æ˜¯9ä½åç§», è€Œæ¯ä¸€çº§é¡µè¡¨éƒ½æ˜¯512=2^9ä¸ªé¡µç›®å½•  
ä»–ä»¬ä¹‹é—´å­˜åœ¨ä»€ä¹ˆè”ç³»ä¹ˆ  
æ˜¾ç„¶æ˜¯æœ‰çš„  
æ¯”å¦‚æˆ‘æœ‰ä¸€ä¸ªè™šæ‹Ÿåœ°å€0xffff800002311000, æŒ‡å‘ä¸€ä¸ª4K page    
(0xffff800002311000 / 0x1000 = 0xffff800002311) % 512 = 273 => pml1tä¸­çš„åç§»  <=> 0xffff800002311000 >> 12 & 0x1ff  
(0xffff800002311 / 0x200 = 0x7fffc000011) % 512 = 17  => pml2tä¸­çš„åç§»        <=> 0xffff800002311000 >> 21 & 0x1ff  
(0x7fffc000011 / 0x200 = 0x3fffe0000) % 512 = 0 => pml3tä¸­çš„åç§»              <=> 0xffff800002311000 >> 30 & 0x1ff  
(0x3fffe0000 / 0x200 = 0x1ffff00 ) % 512 = 256 => pml4tä¸­çš„åç§»               <=> 0xffff800002311000 >> 39 & 0x1ff  
(0x1ffff00 / 0x200 = 0xffff) % 512 = 511 => pml5tä¸­çš„åç§»                     <=> 0xffff800002311000 >> 48 & 0x1ff  
(0xffff / 0x200 = 7f) % 512 = 127 => availableä¸­çš„åç§»                        <=> 0xffff800002311000 >> 57 & 0x1ff  
(0x7f / 0x200 = 0) % 64 = 0 => availableä¸­çš„åç§»                              <=> 0xffff800002311000 >> 64 & 0x1ff  
offsetæ’åˆ—ç»„åˆä¸€ä¸‹  
0 127 511 256 0 17 273  
åæ¨  
0 * 2^64 + 127 * 2^57 + 511 * 2^48 + 256 * 2^39 + 0 * 2 ^ 30 + 17 * 2^21 + 273*2^12 = 0xffff800002311000  
æˆ‘ä»¬æŠŠå…ˆå‰å¾—åˆ°çš„offsetè½¬æ¢ä¸ºäºŒè¿›åˆ¶å…¨éƒ¨å¡«å…¥ä¹‹å‰çš„è¡¨æ ¼  
äºŒè¿›åˆ¶è¡¨ç¤ºä¸º01111111 111111111 100000000 000000000 000010001 100010001 000000000000  
ç»„åˆèµ·æ¥, è½¬æ¢åå¾—åˆ°çš„å€¼å°±æ˜¯0xffff800002311000, ä¸åŸæ¥å®Œå…¨ä¸€è‡´  
å¯¹äºå¤§é¡µ(huge page), åªéœ€è¦ç†è§£ä¸ºèˆå¼ƒæ‰è¿™ä¸€çº§é¡µè¡¨ä»¥ä¸‹çš„æ‰€æœ‰é¡µè¡¨å°±è¡Œ, æ¨å¯¼è¿‡ç¨‹æ˜¯ä¸€æ ·çš„  

åˆ°ç›®å‰ä¸ºæ­¢, æˆ‘ä»¬å·²ç»è®²è§£å®Œäº†å¤§éƒ¨åˆ†çš„åˆ†é¡µçŸ¥è¯†äº†  
MMU,åˆ™æ˜¯èµ·åˆ°ç‰©ç†åœ°å€ä¸è™šæ‹Ÿåœ°å€çš„è½¬æ¢çš„ä½œç”¨
æ¯ä¸ªé¡µç›®å½•é¡¹å†…éƒ½æœ‰ä¸€ä¸ªå­˜å‚¨base address, å½“psä½è¢«è®¾ç½®æˆ–è€…å½“å‰é¡µè¡¨ä¸ºä¸€çº§é¡µè¡¨æ—¶, base addresså­˜å‚¨ç€å¯¹åº”ç‰©ç†åœ°å€
MMU å°±æ˜¯æ ¹æ®ä¸Šé¢è™šæ‹Ÿåœ°å€è½¬æ¢å‡ºè™šæ‹Ÿé¡µç›®å½•é¡¹, åœ¨é¡µè¡¨ä¸­è¿›è¡Œé€çº§æŸ¥æ‰¾, æŠŠå¾—åˆ°çš„ç‰©ç†åœ°å€è¿›è¡Œåˆ†è§£, åˆ†è§£å‡ºå¯¹åº”çš„ç‰©ç†é¡µæ¡†å·ä¸åŸºåœ°å€, å¤§è‡´ä¸ä¸Šé¢è™šæ‹Ÿåœ°å€ç»„åˆå¾ˆåƒ, è¿™è®¾è®¡åˆ°ç¡¬ä»¶æˆ‘ä»¬å°±ä¸è¿‡å¤šæ·±ç©¶äº†  
MMUä¸­è¿˜æœ‰ä¸€ä¸ªå«åšè½¬æ¢æ£€æµ‹ç¼“å†²åŒº(Translation Lookaside Buffer, TLB, åˆå«ä½œå¿«è¡¨)çš„å›ºä»¶, å®ƒçš„å­˜åœ¨æœ‰æ•ˆæé«˜äº†åˆ†é¡µçš„æ•ˆç‡, åšåˆ°å¿«é€Ÿè½¬æ¢
TLBçš„è¯¦ç»†ä»‹ç»åœ¨è¿™é‡Œ[osdev](https://wiki.osdev.org/TLB), æœ¬æ–‡ä¸å¤šåšå™è¿°.  
åˆ·æ–°å¿«è¡¨çš„æ—¶æœºè¦æŒæ¡, åœ¨å–æ¶ˆä¸€ä¸ªé¡µçš„æ˜ å°„çš„æ—¶å€™æˆ–è€…æ˜ å°„ä¸€ä¸ªæ–°çš„é¡µçš„æ—¶å€™å°±è¦åˆ·æ–°TLB  

æœ€åä¸€ä¸ªå°±æ˜¯ç¼ºé¡µå¼‚å¸¸å¤„ç†äº†, è¿™ä¸ªç« èŠ‚å†…å®¹æˆ‘ä»¬æ”¾åˆ°åé¢å†ç ”ç©¶  

æŒæ¡äº†è¿™äº›ç†è®ºçŸ¥è¯†, ä½ å°±å¯ä»¥å¼€å§‹ç¼–å†™ç›¸å¯¹åº”çš„å‡½æ•°.
æºç å¯ä»¥å‚è€ƒ: [page_table.hpp](https://github.com/SegmentationFaultCD/QuantumNEC/blob/limine/include/kernel/memory/paging/page_table.hpp)ä»¥åŠ[page_table.cpp](https://github.com/SegmentationFaultCD/QuantumNEC/blob/limine/source/kernel/memory/paging/page_table.cpp)  

æˆ–è€…, ä½¿ç”¨æˆ‘ä»¬çš„åº“: [libpaging](https://github.com/plos-clan/libpaging)

## æ€»ç»“: åˆ†é¡µæ˜¯å®ç°æ“ä½œç³»ç»Ÿçš„ç¬¬ä¸€å¤§éš¾å…³, ä½†æ˜¯åªè¦æˆ‘ä»¬è‚¯å»è®¤çœŸç ”ç©¶, æŸ¥é˜…æ–‡æ¡£, å°±ä¸éš¾æŒæ¡, ç†è§£è¿™äº›åŠŸèƒ½, æ”»å…‹éš¾å…³
# è‡ªåˆ¶OSæ•™ç¨‹#8 : æ‹¨å¼€äº‘é›¾, æ‰“å°è¾“å‡º
[os-terminal](https://github.com/plos-clan/libos-terminal) -- ä¼˜ç§€çš„ç»ˆç«¯åº“, ä½ è¦åšçš„å°±æ˜¯æŠŠä»–çš„releaseç‰ˆæœ¬ä¸‹è½½ä¸‹æ¥ã€‚  
æŠŠterminal.hå’Œä»»æ„ä¸€ä¸ªç¼–è¯‘å¥½çš„.aæ–‡ä»¶ä¸‹è½½å¹¶é“¾æ¥è¿›å†…æ ¸(ldæŒ‡ä»¤æ€ä¹ˆç”¨æˆ‘å°±ä¸æ•™äº†,è‡ªå·±æŸ¥[ld](https://www.ibm.com/docs/en/aix/7.2.0?topic=l-ld-command))  
è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘è¦ä½ ç›´æ¥å†™ä¸²å£é©±åŠ¨è€Œä¸æ˜¯åƒåˆ«çš„æ•™ç¨‹ä¸€æ ·å…ˆè‡ªå·±å†™printk--æˆ‘ä»¬ä¸éœ€è¦è‡ªå·±å†™æ˜¾å­˜, æˆ‘ä»¬åªç”¨ç°æˆçš„åº“.  
ä½†æ˜¯æˆ‘ä»¬æ€»æ˜¯è¦è°ƒè¯•çš„, å¦‚æœå‡ºç°é”™è¯¯, æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¸²å£è¾“å‡º, è€Œä¸ç”¨è´¹æ—¶è´¹åŠ›æ€è€ƒæ€ä¹ˆå†™æ˜¾å­˜  
æ€ä¹ˆç”¨å°±æŒ‰ç…§äººå®¶æ–‡æ¡£æ•™çš„æ“ä½œå§  
å‰©ä¸‹çš„å°±æ˜¯æˆ‘ä»¬è¦è‡ªå·±å†™ä¸€ä¸ªvsprintf/format, å¾—åˆ°æ ¼å¼åŒ–å­—ç¬¦ä¸², ç„¶åè°ƒç”¨ostæä¾›çš„æ‰“å°å‡½æ•°å³å¯.  
æ•´ä¸ªæµç¨‹æˆ‘ä»¬å°±å°è£…æˆprintk, æˆ–è€…ä½ çˆ±å«ä»€ä¹ˆå°±å«ä»€ä¹ˆ.  
C++ç‰ˆæœ¬: formatå¯ä»¥ç”¨æˆ‘å†™çš„: [libformat](https://github.com/plos-clan/libformat), æŒ‰ç…§æ•™ç¨‹æ“ä½œ  
Cç‰ˆæœ¬: vsprintfå¯ä»¥çœ‹CPOSçš„å®ç°: [vsprintf]()  
è¿™ä¸ª, åº”è¯¥ä¸ç”¨æ•™äº†å§, å°è£…æ‰“å°ï¼Œä¸€æ¡é¾™æœåŠ¡å•Š  
# è‡ªåˆ¶OSæ•™ç¨‹#9 : é«˜çº§ä¸­æ–­å¤„ç†
# è‡ªåˆ¶OSæ•™ç¨‹#10 : SIMDæµ®ç‚¹æ”¯æŒ
# è‡ªåˆ¶OSæ•™ç¨‹#11 : å¤šæ ¸!
# è‡ªåˆ¶OSæ•™ç¨‹#12 : ä»»åŠ¡è°ƒåº¦, éš¾ä¸ŠåŠ éš¾, å™©æ¢¦æ­»é”çš„å¤„ç†æ–¹æ³•
# è‡ªåˆ¶OSæ•™ç¨‹#13 : ç³»ç»Ÿè°ƒç”¨
# è‡ªåˆ¶OSæ•™ç¨‹#14 : å†…æ ¸æ¶æ„, å¾®å†…æ ¸è®¾è®¡ä¸è¿›ç¨‹é—´é€šä¿¡
# è‡ªåˆ¶OSæ•™ç¨‹#15 : åˆè§ç«¯å€ª--æ–‡ä»¶ç³»ç»Ÿä¸æ¨¡å—åŒ–
# è‡ªåˆ¶OSæ•™ç¨‹#17 : å¤§å½»å¤§æ‚Ÿ--VFS
# è‡ªåˆ¶OSæ•™ç¨‹#18 : è®¾å¤‡é©±åŠ¨
# è‡ªåˆ¶OSæ•™ç¨‹#19 : å¼‚å¸¸å¤„ç†å†ä¸€æ¸¸--å†™æ—¶å¤åˆ¶ä¸é¡µé¢ç½®æ¢ç®—æ³•
# è‡ªåˆ¶OSæ•™ç¨‹#20 : POSIXæ¥å£æ¢ç§˜
